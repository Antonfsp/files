\documentclass{article}

\usepackage{amsmath,amssymb}
\allowdisplaybreaks


\begin{document}

\section{Problem description}

Let $N=\{1,...,n\}$ be a set of agents. Let $G=(V,E)$ be a direct graph with $V$ and $E$ the sets
of nodes and edges respectively. Each edge $e \in E$ will be noted by a tuple, $e=(v,w,i)$, indicating that it 
connects the node $v\in V$ with the node $w \in V$ and that his owner is the agent $i\in N$. Note that could exist as
many edges between a pair of nodes as agents exists. Each edge $e \in E$ has a capacity $q_e$ and a cost for using it, $c_e$.

Let $\Theta$ be the set of commodities. Each commodity is noted by a tuple, $(o,t,i)$, where $o\in V$ is its origin
node, $t\in V$ its destiny node and $i$ is the agent who owns it. Each commodity $(o,t,i)$ has a size, $d_{(o,t,i)}$
and an associated revenue $r_{(o,t,i)}$ that its owner earns if the commodity is succesfully delivered from $o$ to $t$.

The commodities are unsplitable, i.e., can not be divided into different edges. The cost of an edge $e \in E$ would be payed 
by his owner if the edge is used to route any commodity, regardless of who is the owner of the commodity
or which fraction of its total capacity is effectively used.

We will note by $E^i \subset E$ and $\Theta^i\subset \Theta$ the subsets of edges and commodities owned by agent $i$.


\subsection{Single agent model}

Lets first introduce the problem for a single agent. The objective of an agent 
$i \in N$ is to maximize her payoff, by routing her commodities from their origin nodes
to their terminal nodes through the edges she owns, for what she have to pay the
activation cost of the edges she end up using and respect their capacities.

Thus, the problem which agent $i\in N$ has to solve can be modeled as the following
ILPm which we will call $P_i$:





\begin{subequations}
    \begin{alignat}{3}
        &  P_i: \max  & \hspace{22pt} \sum_{(o,t,i)\in \Theta^i} \sum_{e \in IE^i(t)}  f_e^{(o,t,i)} \cdot d_{(o,t,i)} \cdot r - \sum_{e'\in E^i} u_{e'}\cdot c_{e'} \hspace{40pt} &&   \label{eq:SingleAgentA}
    \end{alignat}
    \begin{alignat}{3}
        & \text{subject to}       & \sum_{e \in IE^i(z)} f_e^{(o,t,i)}-\sum_{e' \in OE^i(z)} f_{e'}^{(o,t,i)} & = 0,                                   && \forall\ z\in V\setminus\{o,t\},\nonumber\\[-1em]
        &                         &                                                                           &                                        && \forall\ (o,t,i)\in\Theta^i,  \label{eq:SingleAgentB}\\[1em]
        &                         & \sum_{e \in OE^i(o)} f_e^{(o,t,i)}                                        & \leq 1,                                && \forall\ (o,t,i)\in \Theta^i, \label{eq:SingleAgentC} \\
        &                         & \sum_{e \in OE^i(t)} f_e^{(o,t,i)}                                        & = 0,                                   && \forall\ (o,t,i)\in \Theta^i, \label{eq:SingleAgentD} \\
        &                         & \sum_{(o,t,i) \in \Theta^i} f_e^{(o,t,i)}\cdot d_{(o,t,i)}                & \leq u_e\cdot q_{(o,t,i)},\hspace{8pt} && \forall\ e \in E^i, \label{eq:SingleAgentE}  \\
        &                         & \sum_{v \in S} \sum_{w \in S} f_{(v,w)}^{(o,t,i)}                         & \leq |S| -1,                           && \forall\ S \subset V, \nonumber\\[-1em]
        &                         &                                                                           &                                        && \forall\ (o,t,i) \in \Theta^i, \label{eq:SingleAgentF}\\[1em]
        &                         & f_e^{(o,t,i)}                                                             & \in \{0,1\},                           && \forall\ e \in E^i,\nonumber\\
        &                         &                                                                           &                                        && \forall\ (o,t,i) \in \Theta^i, \label{eq:SingleAgentG} \\[1em]  
        &                         &  u_e                                                                      & \in \{0,1\},                           && \forall\ e \in E^i 
    \end{alignat}

\end{subequations}

Equation (\ref{eq:SingleAgentA}) maximizes the profits of agent $i$. 

Constraint (\ref{eq:SingleAgentB}) ensures that, for any commodity, the flow that enters and leaves transit nodes (neither the origin neither the terminal) is equal.


Constraints (\ref{eq:SingleAgentC}), together with (\ref{eq:SingleAgentG}), ensures that any commodity, in case of be send, is completely send and only through and edge from its origin node.

Constraint (\ref{eq:SingleAgentD}) ensures that none commodity is send from its terminal node. Constraint (\ref{eq:SingleAgentE}) ensures that the capacity of edges is not exceed. It might be unnecessary
Constraint (\ref{eq:SingleAgentF}) is a subtour elimination constraint.

We will note by $P_i^*$ the optimal solution of $P_i$.

\subsection{Different types of cooperation}

In the previous subsection, we have presented the model of the problem when an agent $i\in N$ works independently of the other
agent in $N$. In this subsection, we present different cooperative mechanisms which the agents
in $N$ could make use of in order to find synergies among them and increase their payoffs.

e will consider 3 different mechanism of colaboration between the agents. These mechanisms are distinguished from each other on
the number of decisions that are left to a central planner. 


\begin{table}[h!]
    \begin{tabular}{cc|ccc}
        & &      \multicolumn{3}{|c}{Level cooperation} \\\cline{3-5}
        & & Partial-1 & Partial-2 & Full \\ \hline
        AGENT & Activate edges & Yes & Yes & No \\
        '' & Route flow     & Yes & No & No \\\hline
        Central planner & Activate edges & No & No & Yes \\
        '' & Route flow & Yes & Yes & Yes
        \end{tabular}
    \end {table}

\subsubsection*{Partial-1 cooperation}


In the first type of cooperation, what we will call ``Partial-1 cooperation'', each agent $i\in N$ will solve its own ($P^i$) problem and 
then pass to the central planner the demands he was not able to serve and the not used capacity of the 
edges he has activated. Will the information from all the agents, the central planner will try to maximize
the profits of the grand coalition, routing the unserved commodities through the not used capacity
of the edges. If a commodity is route through an edge ow by a different agent, the owner of the commodity
will pay to the owner of the edge the proportional cost of the fraction of the capacity of th edge he is using.

Therefore, the central planner would be solving the following model:


\begin{subequations}
    \begin{alignat}{3}
        &  \Gamma_1: \max  & \sum_{(o,t,i) \in \Theta} \left[\sum_{e \in OE(o)}  f_e^{(o,t,i)} \cdot d_{(o,t,i)} \cdot r_{(o,t,i)} - \sum_{\substack{e \in E^j\colon \\ j\not = i}} f_e^{(o,t,i)} \cdot \frac{c_e}{q_e} \right] &&   \label{eq:Partial1CooperationA} 
    \end{alignat}
    \begin{alignat}{3}
        & \text{subject to}       & \sum_{e \in IE(z)} f_e^{(o,t,i)}-\sum_{e' \in OE(z)} f_{e'}^{(o,t,i)} & = 0,            && \forall\ z\in V\setminus\{o,t\},\nonumber\\[-1em]
        &                         &                                                                       &                 && \forall\ (o,t,i)\in\Theta,  \label{eq:Partial1CooperationB}\\[1em]
        &                         & \sum_{e \in OE(o)} f_e^{(o,t,i)}                                      & \leq 1,         && \forall\ (o,t,i)\in \Theta, \label{eq:Partial1CooperationC} \\
        &                         & \sum_{e \in OE(t)} f_e^{(o,t,i)}                                      & = 0,            && \forall\ (o,t,i)\in \Theta, \label{eq:Partial1CooperationD} \\
        &                         & \sum_{(o,t,i) \in \Theta} f_e^{(o,t,i)}\cdot d_{(o,t,i)}              & q_{(o,t,i)}     && \forall\ e \in E, \label{eq:Partial1CooperationE}  \\
        &                         & \sum_{v \in S} \sum_{w \in S} f_{(v,w)}^{(o,t,i)}                     & \leq |S| -1,    && \forall\ S \subset V, \nonumber\\[-1em]
        &                         &                                                                       &                 && \forall\ (o,t,i) \in \Theta, \label{eq:Partial1CooperationF}\\[1em]
        &                         & f_e^{(o,t,i)}                                                         & \in \{0,1\},    && \forall\ e \in E,\nonumber\\
        &                         &                                                                       &                 && \forall\ (o,t,i) \in \Theta, \label{eq:Partial1CooperationG} 
    \end{alignat}
\end{subequations}

where $E$ is the set of all the edges, $e$, activated by an agent and with some not used capacity, $q_e$; and 
$\Theta$ is the set of all the demands that the agent left unserved.

We will note by $\Gamma_1^*$ the optimal solution of  $\Gamma_1$, and by $\varphi_i(\Gamma_1^*)$ the payoff corresponding to
agent $i$, with

\begin{align}
    \begin{split}
    \varphi_i(\Gamma_1) = & \sum_{(o,t,i)\in \Theta^i} \left[ \sum_{e \in IE^i(o)} f_e^{(o,t,i)} \cdot d_{(o,t,i)} \cdot r_{(o,t,i)} - \right. \\
                          & \left. - \sum_{e'\in \Theta^j \colon j\not = i} f_e^{(o,t,i)} \cdot d_{(o,t,i)} \cdot \frac{c_{e'}}{q_{e'}} \right] + \\
                          & + \sum_{(o,t,k) \in \Theta \colon k \not = i} \sum_{e'' \in E^i} f_{e''}^{(o,t,k)} \cdot d_{(o,t,k)} \cdot \frac{c_{e''}}{q_{e''}},
    \end{split}
\end{align}

for every $i \in N$. Note that the first sum equals the payoff that agent $i$ obtains from each of her demands, i.e., the 
revenue she obtains from subcessfully serving it minus the cost of the commodity being route through edges of another agents.
The second sum equals the ``side payments'' that agent $i$ obtains from other agents whose commodities are route through her edges.
Thus, the final payoff of each agent $i\in N$ when the Partial-1 cooperation is used would be $\varphi_i(\Gamma_1^*)+P_i^*$


\subsubsection*{Partial-2 cooperation}

In the second type of cooperation that we study, ``Partial-2 cooperation'', all the agent will also start by solving
their $P^i$ problems. Once they have done it, they do not route any commodity, but they pass all the commodities to the central
planner, as well as all the edges they activate following their optimal solution for $(P^i)$. Then, as in ``Partial-1 cooperation'',
the central planner will try to maximize the profits of the Grand Coalition, but also ensuring that any agent will get a final payoff smaller
than what he will optain without cooperation. Therefore, to the model of ``Partial-1 cooperation'' is added the following constraint:


\begin{subequations}
    \begin{alignat}{3}
        &  \Gamma_2: \max  & \sum_{(o,t,i) \in \Theta} \left[\sum_{e \in OE(o)}  f_e^{(o,t,i)} \cdot d_{(o,t,i)} \cdot r_{(o,t,i)} - \sum_{\substack{e \in E^j\colon \\ j\not = i}} f_e^{(o,t,i)} \cdot \frac{c_e}{q_e} \right] &&   \label{eq:Partial2CooperationA} 
    \end{alignat}
    \begin{alignat}{3}
        & \text{subject to}       & \sum_{e \in IE(z)} f_e^{(o,t,i)}-\sum_{e' \in OE(z)} f_{e'}^{(o,t,i)} & = 0,            && \forall\ z\in V\setminus\{o,t\},\nonumber\\[-1em]
        &                         &                                                                       &                 && \forall\ (o,t,i)\in\Theta,  \label{eq:Partial2CooperationB}\\[1em]
        &                         & \sum_{e \in OE(o)} f_e^{(o,t,i)}                                      & \leq 1,         && \forall\ (o,t,i)\in \Theta, \label{eq:Partial2CooperationC} \\
        &                         & \sum_{e \in OE(t)} f_e^{(o,t,i)}                                      & = 0,            && \forall\ (o,t,i)\in \Theta, \label{eq:Partial2CooperationD} \\
        &                         & \sum_{(o,t,i) \in \Theta} f_e^{(o,t,i)}\cdot d_{(o,t,i)}              & q_{(o,t,i)}     && \forall\ e \in E, \label{eq:Partial2CooperationE}  \\
        &                         & \sum_{v \in S} \sum_{w \in S} f_{(v,w)}^{(o,t,i)}                     & \leq |S| -1,    && \forall\ S \subset V, \nonumber\\[-1em]
        &                         &                                                                       &                 && \forall\ (o,t,i) \in \Theta, \label{eq:Partial2CooperationF}\\[1em]
        &                         & \varphi(\Gamma_2(i))                                                  & \geq P_i^*,     && \forall\ i\in N \label{eq:Partial2CooperationG}\\
        &                         & f_e^{(o,t,i)}                                                         & \in \{0,1\},    && \forall\ e \in E,\nonumber\\
        &                         &                                                                       &                 && \forall\ (o,t,i) \in \Theta, \label{eq:Partial2CooperationH}
    \end{alignat}
\end{subequations}

Constraint (\ref{eq:Partial2CooperationG}) ensures that the flow is routed in such a way that every agent ends up with a payoff equal or greater than what (s)he could
optain without cooperation.

\subsubsection*{Full cooperation}


The final type of cooperation we study, ``Full cooperation'', is the case where all the agent pass to the central planner all their commodities,
and let the central planner to decide which edges to activate and how to route the commodities.
As in ``Partial-2 cooperation'', the central planner must ensure that any agent end up with a payoff
smaller than what (s)he would have obtained without cooperation.

\begin{subequations}
    \begin{alignat}{3}
        &  \Gamma_F: \max  & \hspace{22pt} \sum_{(o,t,i)\in \Theta} \sum_{e \in IE(t)}  f_e^{(o,t,i)} \cdot d_{(o,t,i)} \cdot r - \sum_{e'\in E} u_{e'}\cdot c_{e'} \hspace{40pt} &&   \label{eq:FullCooperationA}
    \end{alignat}
    \begin{alignat}{3}
        & \text{subject to}       & \sum_{e \in IE(z)} f_e^{(o,t,i)}-\sum_{e' \in OE(z)} f_{e'}^{(o,t,i)} & = 0,                                   && \forall\ z\in V\setminus\{o,t\},\nonumber\\[-1em]
        &                         &                                                                           &                                        && \forall\ (o,t,i)\in\Theta,  \label{eq:FullCooperationB}\\[1em]
        &                         & \sum_{e \in OE(o)} f_e^{(o,t,i)}                                        & \leq 1,                                && \forall\ (o,t,i)\in \Theta, \label{eq:FullCooperationC} \\
        &                         & \sum_{e \in OE(t)} f_e^{(o,t,i)}                                        & = 0,                                   && \forall\ (o,t,i)\in \Theta, \label{eq:FullCooperationD} \\
        &                         & \sum_{(o,t,i) \in \Theta} f_e^{(o,t,i)}\cdot d_{(o,t,i)}                & \leq u_e\cdot q_{(o,t,i)},\hspace{8pt} && \forall\ e \in E, \label{eq:FullCooperationE}  \\
        &                         & \sum_{v \in S} \sum_{w \in S} f_{(v,w)}^{(o,t,i)}                         & \leq |S| -1,                           && \forall\ S \subset V, \nonumber\\[-1em]
        &                         &                                                                           &                                        && \forall\ (o,t,i) \in \Theta, \label{eq:FullCooperationF}\\[1em]
        &                         & \varphi_i(\Gamma_F)                                                           & \geq P_i^*,     && \forall\ i\in N \label{eq:FullCooperationG}\\
        &                         & f_e^{(o,t,i)}                                                             & \in \{0,1\},                           && \forall\ e \in E,\nonumber\\
        &                         &                                                                           &                                        && \forall\ (o,t,i) \in \Theta, \label{eq:FullCooperationH} \\[1em]  
        &                         &  u_e                                                                      & \in \{0,1\},                           && \forall\ e \in E 
    \end{alignat}

with 
    \begin{align}
        \begin{split}
        \varphi_i(\Gamma_F) = & \sum_{(o,t,i)\in \Theta^i} \left[ \sum_{e \in IE^i(o)} f_e^{(o,t,i)} \cdot d_{(o,t,i)} \cdot r_{(o,t,i)} - \right. \\
                              & \left. - \sum_{e'\in \Theta^j \colon j\not = i} f_e^{(o,t,i)} \cdot d_{(o,t,i)} \cdot \frac{c_{e'}}{q_{e'}} \right] + \\
                              & + \sum_{(o,t,k) \in \Theta \colon k \not = i} \sum_{e'' \in E^i} f_{e''}^{(o,t,k)} \cdot d_{(o,t,k)} \cdot \frac{c_{e''}}{q_{e''}} -\\
                              & - \sum_{e \in E^i} u_e \cdot c_e,
        \end{split}
    \end{align}
    


\end{subequations}

\end{document}